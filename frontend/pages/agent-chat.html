<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat com Agente IA | Planej.AI</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" href="../img/favicon.ico" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <img src="../img/logo.jpeg" alt="Planej.AI Logo">
                <h1>Planej.AI</h1>
            </div>
            <div class="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <nav class="nav-links">
                <a href="dashboard.html">Painel</a>
                <a href="financial-data.html">Dados</a>
                <a href="agent-chat.html" class="active">Agente</a>
            </nav>
            <div class="user-actions">
                <div class="theme-toggle">
                    <i class="fas fa-moon"></i>
                </div>
                <div class="user-profile">
                    <img src="../img/avatar.png" alt="Avatar" style="width: 40px; height: 40px; border-radius: 50%;">
                    <span>Ol√°, Sergio</span>
                    <i class="fas fa-chevron-down" style="font-size: 0.8rem; margin-left: 5px;"></i>
                    
                    <!-- Dropdown Menu -->
                    <div class="profile-dropdown">
                        <ul>
                            <li><a href="#"><i class="fas fa-user"></i> Meu Perfil</a></li>
                            <li><a href="#"><i class="fas fa-cog"></i> Configura√ß√µes</a></li>
                            <li><a href="#"><i class="fas fa-credit-card"></i> Assinatura</a></li>
                            <li><a href="#"><i class="fas fa-question-circle"></i> Ajuda</a></li>
                            <li><a href="../index.html"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Chat Section -->
    <section class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <h2>Fale com a Corujita</h2>
                    <p>Converse com nosso assistente inteligente para obter insights e recomenda√ß√µes personalizadas</p>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="chat-container">
                
                <div class="chat-main">
                    <div class="chat-header">
                        <div class="chat-header-avatar">
                            <span style="font-size: 2rem;">ü¶â</span>
                        </div>
                        <div class="chat-header-info">
                            <h3>Corujita - Assistente Financeira</h3>
                            <p>Online</p>
                        </div>
                    </div>
                    
                    <div class="chat-messages">
                        <!-- Mensagens do chat ser√£o inseridas dinamicamente pelo JS -->
                    </div>
                    
                    <form class="chat-input">
                        <input type="text" placeholder="Digite sua mensagem...">
                        <button type="submit"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>

            <!-- Suggested Questions -->
            <div class="card" style="margin-top: 30px;">
                <div class="card-header">
                    <div class="card-title">Perguntas Sugeridas</div>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <button class="btn btn-outline pergunta-sugerida" style="text-align: left;">Como posso reduzir minhas despesas operacionais?</button>
                        <button class="btn btn-outline pergunta-sugerida" style="text-align: left;">Qual √© a melhor estrat√©gia para aumentar minha receita?</button>
                        <button class="btn btn-outline pergunta-sugerida" style="text-align: left;">Como otimizar meu capital de giro?</button>
                        <button class="btn btn-outline pergunta-sugerida" style="text-align: left;">Quais s√£o os melhores investimentos para meu neg√≥cio?</button>
                        <button class="btn btn-outline pergunta-sugerida" style="text-align: left;">Como melhorar minha gest√£o de estoque?</button>
                        <button class="btn btn-outline pergunta-sugerida" style="text-align: left;">Quais s√£o os riscos financeiros do meu neg√≥cio?</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/main.js"></script>
    <script>
// Permitir envio de perguntas sugeridas como mensagem do usu√°rio
function addChatMessage(message, isUser = false, isLoading = false) {
  const chatMessages = document.querySelector('.chat-messages');
  if (!chatMessages) return;
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${isUser ? 'outgoing' : 'incoming'}`;
  const avatarDiv = document.createElement('div');
  avatarDiv.className = `chat-message-avatar ${isUser ? 'user' : 'agent'}`;
  avatarDiv.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<span style="font-size: 1.7rem;">ü¶â</span>';
  const contentDiv = document.createElement('div');
  contentDiv.className = 'chat-message-content';
  if (isLoading) {
    contentDiv.innerHTML = `<span class="typing-indicator"><span>.</span><span>.</span><span>.</span></span>`;
  } else {
    contentDiv.textContent = message;
  }
  messageDiv.appendChild(avatarDiv);
  messageDiv.appendChild(contentDiv);
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function sendMessageToAgent(message, conversationId = null, isWelcome = false) {
  if (!isWelcome) addChatMessage(message, true);
  // Remover qualquer indicador de digita√ß√£o anterior
  const chatMessages = document.querySelector('.chat-messages');
  const oldTyping = chatMessages.querySelector('.chat-message.typing');
  if (oldTyping) oldTyping.remove();
  // Adicionar novo indicador de digita√ß√£o animado
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'chat-message incoming typing';
  const avatarDiv = document.createElement('div');
  avatarDiv.className = 'chat-message-avatar agent';
  avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
  const contentDiv = document.createElement('div');
  contentDiv.className = 'chat-message-content';
  contentDiv.innerHTML = `<span class="typing-indicator"><span>.</span><span>.</span><span>.</span></span>`;
  loadingDiv.appendChild(avatarDiv);
  loadingDiv.appendChild(contentDiv);
  chatMessages.appendChild(loadingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  fetch('https://finance.astraflow.io/users/financial-agent/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ question: message, conversation_id: conversationId })
  })
    .then(resp => resp.json())
    .then(data => {
      // Remove indicador de digita√ß√£o
      const typingDiv = chatMessages.querySelector('.chat-message.typing');
      if (typingDiv) typingDiv.remove();
      addChatMessage(data.resposta, false);
      // Salvar conversation_id para manter contexto
      if (data.conversation_id) {
        window.currentConversationId = data.conversation_id;
      }
    });
}

document.addEventListener('DOMContentLoaded', function() {
  const perguntas = document.querySelectorAll('.pergunta-sugerida');
  perguntas.forEach(btn => {
    btn.addEventListener('click', function() {
      const chatInput = document.querySelector('.chat-input input');
      if (chatInput) {
        chatInput.value = this.textContent;
        // Disparar o envio como se fosse o usu√°rio
        const chatForm = document.querySelector('.chat-input');
        if (chatForm) {
          chatForm.dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}));
        }
      }
    });
  });

  // Mensagem de boas-vindas da IA ao carregar a p√°gina
  setTimeout(function() {
    sendMessageToAgent('Se apresente e d√™ boas-vindas ao usu√°rio, explique que voc√™ √© a Corujita, assistente financeira IA, pronta para ajudar!', null, true);
  }, 400);

  // Envio de mensagem pelo formul√°rio
  const chatForm = document.querySelector('.chat-input');
  if (chatForm) {
    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const input = chatForm.querySelector('input');
      const message = input.value.trim();
      if (message) {
        sendMessageToAgent(message, window.currentConversationId);
        input.value = '';
      }
    });
  }
});
</script>
<style>
.typing-indicator {
  display: inline-block;
  font-size: 2rem;
  letter-spacing: 2px;
}
.typing-indicator span {
  display: inline-block;
  animation: blink 1.4s infinite both;
}
.typing-indicator span:nth-child(1) {
  color: #00c9a7;
}
.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
  color: #ff9f43;
}
.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
  color: #4a47a3;
}
@keyframes blink {
  0%, 80%, 100% { opacity: 0; }
  40% { opacity: 1; }
}
</style>
</body>
</html>
